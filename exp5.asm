
LED1 EQU 44H
LED2 EQU 45H
LED3 EQU 46H
LED4 EQU 47H
TIMING EQU 48H
HIGHER EQU 49H
LOWER  EQU 4AH

ORG 0000H
LJMP START
ORG 000BH
LJMP INTTI
ORG 0023H
LJMP INT_SERIAL
ORG 0060H

; 初始化
START:
MOV SP, #60H    ; 设置堆栈地址
MOV LED1, #00H
MOV LED2, #00H
MOV LED3, #00H
MOV LED4, #00H
MOV HIGHER, #00H
MOV LOWER, #00H
MOV 40H, #00H
MOV 41H, #00H
MOV 42H, #00H
MOV 43H, #00H
MOV R5, #40H
MOV SCON,#50H 	; 串行口 工作方式1
SETB EA
SETB ET0
SETB ES
MOV TMOD,#21H    ;t0方式1，t1方式2
MOV TL1,#0FDH 	 ;9600 bps
MOV TH1,#0FDH
MOV TL0,#00H
MOV TH0,#4CH
MOV TIMING,#60	 ;60*50ms=3s
SETB TR1
SETB TR0
MOV R0,#30H 	 ; 字符串在内存中的起始地址
MOV R1,#0EH		 ; 字符串大小
MOV DPTR,#DSEG1
MOV B,#00H
LOAD:		     ; 将"I LOVE CHINA!\n"的ascii码存入内存
MOV A,B
MOVC A,@A+DPTR
MOV @R0,A
INC R0
INC B
DJNZ R1,LOAD
LOOP:                 ; 计算结果并输出
LCALL DISPLAY
JNB P1.6,CALCULATOR   ; 检查是否接收到数据, 计算结果
JMP LOOP

CALCULATOR:
LCALL CALCULATION
LJMP LOOP

; 穿行口中断
INT_SERIAL:
PUSH PSW        ; 入栈
PUSH ACC
PUSH DPH
PUSH DPL
JB RI,RECEIVE   ; 接受数据
CLR TI          ; 清零ti
POP DPL         ; 出栈
POP DPH
POP ACC
POP PSW
RETI

; 时钟中断1
INTTI:
PUSH PSW  ; 寄存器入栈
PUSH ACC
PUSH DPH
PUSH DPL
MOV TL0,#00H ; TLTH复位
MOV TH0,#4CH
DJNZ TIMING,NEXT1  ; 计数器-1到达三秒
AJMP SENDING    ; 到达三秒，传输字符串
NEXT1:
POP DPL
POP DPH
POP ACC
POP PSW
RETI

; 数码管显示子程序
DISPLAY:
MOV A,LED1
ANL A,#0FH
MOV DPTR,#DSEG2
MOVC A,@A+DPTR
MOV DPTR,#7FF8H
MOVX @DPTR,A

MOV A,LED2
ANL A,#0FH
MOV DPTR,#DSEG2
MOVC A,@A+DPTR
MOV DPTR,#7FF9H
MOVX @DPTR,A

MOV A,LED3
ANL A,#0FH
MOV DPTR,#DSEG2
MOVC A,@A+DPTR
MOV DPTR,#7FFAH
MOVX @DPTR,A

MOV A,LED4
ANL A,#0FH
MOV DPTR,#DSEG2
MOVC A,@A+DPTR
MOV DPTR,#7FFBH
MOVX @DPTR,A
RET

; 将字符串传输给pc端
SENDING:
MOV TIMING,#60
CPL P1.7
MOV R1, #30H	        ;存储地址
MOV R2, #0EH 		    ;数据长度
MOV R7, #00H
MOV DPTR, #DSEG1
LOOP_SENDING:
MOV A, R7
MOVC A, @A+DPTR
MOV SBUF, A
;MOV SBUF,@R1
JNB TI,$
CLR TI
;INC R1
INC R7
DJNZ R2,LOOP_SENDING
RETI

; 串行接收
RECEIVE:
CLR P1.6
MOV A,R5
MOV R0,A
MOV @R0,SBUF
CJNE R5,#43H,CONTI
MOV R5,#3FH
CONTI:
INC R5
CLR RI
RETI

; 计算和
CALCULATION:
MOV LED1,#00H
MOV LED2,#00H
MOV LED3,#00H
MOV LED4,#00H
MOV HIGHER,#00H
MOV LOWER,#00H
CLR C
MOV A,40H
ADDC A,41H
JNC PLUS2
INC HIGHER
CLR C

PLUS2:
ADDC A,42H
JNC PLUS3
INC HIGHER
CLR C

PLUS3:
ADDC A,43H
JNC FINAL
INC HIGHER
CLR C

FINAL:
MOV LOWER,A
MOV A,HIGHER
JZ STEP2
STEP1:
MOV A,LOWER
SUBB A,#100
JC DECREASE
INC LED2
MOV LOWER,A
AJMP STEP1

DECREASE:
DEC HIGHER
INC LED2
CLR C
MOV LOWER,A
MOV A,HIGHER
JZ STEP2
AJMP STEP1

STEP2:
MOV A,LOWER
MOV B,#100
DIV AB
ADD A,LED2
MOV LED2,A
MOV A,B
MOV B,#10
DIV AB
MOV LED3,A
MOV LED4,B
MOV A,LED2
CJNE A,#0AH,RECOVERY2
MOV LED2,#00H
INC LED1

RECOVERY2:
SETB P1.6
RET

; I love China
DSEG1:
DB 49H,20H,6CH,6FH
DB 76H,65H,20H,43H
DB 68H,69H,6EH,61H
DB 21H,0DH
; 数字
DSEG2:
DB 0C0H,0F9H,0A4H,0B0H
DB 99H,92H,82H,0F8H
DB 80H,90H,88H,83H
DB 0C6H,0A1H,86H,8EH
DB 0FFH
END
